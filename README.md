# System Configurations

This repository holds the [Home Manager][home-manager] and
[nix-darwin][nix-darwin] configurations for my machines. I don't expect anyone
else to use this, but I figured I'd leave the repo public as a resource for
people who want to manage their systems similarly.

## Table of Contents

<!--
  DO NOT EDIT THE TABLE OF CONTENTS MANUALLY.
  It gets generated by doctoc:
  https://github.com/thlorenz/doctoc
  To regenerate, run `just check generate`. Though the pre-push hook will
  automatically run this for you.
-->
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [Applying a Configuration](#applying-a-configuration)
  - [Hosts](#hosts)
  - [Steps](#steps)
- [Running the Home Configuration](#running-the-home-configuration)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Applying a Configuration

### Hosts

For reference, here are all the hosts, grouped by host manager, in the format
"\<host_name> / \<platform>":

<!-- START_CONFIGURATIONS -->

- Home Manager

  - desktop / x86_64-linux

- nix-darwin

  - bigmac / x86_64-darwin

<!-- END_CONFIGURATIONS -->

### Steps

<!--
  I used to use HTML comments to denote the start and end of the nix version e.g.
  <!-- START_VERSION>...<!-- END_VERSION>, but when prettier hard-wrapped the line
  and moved the version to its own line, the version was on its own line in the
  rendered markdown as well. I tested this with a few other markdown parsers and it
  seems like content between two comment tags gets its own line. To avoid this, I use
  an id. Prettier did warn that some renderers would be whitespace-sensitive[1].

  [1]: https://prettier.io/docs/en/options.html#prose-wrap
-->

1. Install Nix using the [Determinate Systems Nix
   Installer][determinate-systems-installer]. Make sure you install the same
   version of nix as the one being used in this flake,
   <code id="nix-version">2.24.8</code>. You can specify a version by doing
   something like the following (make sure you update the platform used in the
   URL to match that of your host):

   > NOTE: The installer may have changed since this was written so make sure
   > everything below is still valid.

   ```bash
   ./nix-installer install \
     --nix-package-url https://releases.nixos.org/nix/nix-2.24.8/nix-2.24.8-x86_64-linux.tar.xz
   ```

2. The following command will start a fish shell within a Nix shell containing
   the other required programs, set the binary caches, and clone the repository
   by running:

   <!-- SYNC: SYS_CONF_PUBLIC_KEYS SYS_CONF_SUBS -->

   ```bash
   nix shell nixpkgs#fish nixpkgs#direnv nixpkgs#gitMinimal \
     --command fish --init-command '
       # Fish does not have a way to exit whenever a command fails so I am
       # manually adding `|| exit`.
       # https://github.com/fish-shell/fish-shell/issues/510

       echo "
         extra-trusted-public-keys = artifacts.bigo.lu-1:AJELdgYsv4CX7rJkuGu5HuVaOHcqlOgR07ZJfihVTIw= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
         extra-substituters = https://artifacts.bigo.lu https://nix-community.cachix.org
       " | sudo tee -a /etc/nix/nix.conf || exit

       # Reload the daemon so it picks up the configuration changes.
       if uname | grep -q Linux
         systemctl restart nix-daemon.service || exit
       else
         sudo launchctl kickstart -k system/org.nixos.nix-daemon || exit
       end

       direnv hook fish | source || exit
       git clone https://github.com/bigolu/system-configurations.git ~/code/system-configurations || exit
       cd ~/code/system-configurations || exit
       direnv allow || exit
       direnv exec "$PWD" nix-direnv-reload || exit
     '
   ```

3. The next steps depend on the operating system you're using:

   - Linux

     1. Apply a Home Manager configuration by running
        `just init-home-manager <host_name>` where `<host_name>` is any
        compatible host from the [host list](#hosts).

     2. Install and start [`keyd`][keyd]

     3. Apply the Firefox `about:config` changes in
        `dotfiles/firefox-developer-edition/about-config-changes.txt`

   - macOS

     1. Apply a nix-darwin configuration by running
        `just init-nix-darwin <host_name>` where `<host_name>` is any compatible
        host from the [host list](#hosts).

     2. Keyboard:

        - Set the keyboard input source to 'Others → (No Accent Keys)'.

        <!--
          I can automate shortcuts when this issue gets resolved:
          https://github.com/LnL7/nix-darwin/issues/185
        -->

        - Shortcuts:

          - Disable: "Select the previous input source" `ctrl+space`,
            "Application windows" `ctrl+↓`

          - Change: "Mission Control → Move left/right a space" to `cmd+[` and
            `cmd+]` respectively, "Mission Control" to `cmd+d`, "Mission Control
            → Switch to Desktop 1-9" `cmd+[1-9]`

     3. Open Hammerspoon, Finicky, MonitorControl, UnnaturalScrollWheels,
        Nightfall, and "Mac Mouse Fix" to configure them.

## Running the Home Configuration

You can also run a shell with the home configuration already loaded in it. This
is helpful when you only need to use the configuration temporarily and not apply
it, like when you're in a remote host or container. The executable is a
self-extracting archive (SEA) that contains all the command-line programs I use,
as well as my config files for them. You can download it from the [releases
page][releases].

> NOTE: While the SEA doesn't depend on any programs on your computer, it does
> require that you have a `/tmp` directory. You can read this [GitHub issue
> comment regarding a "rootless Nix"][rootless-nix] to see why this is needed,
> as well as learn more about how this works.

[determinate-systems-installer]:
  https://github.com/DeterminateSystems/nix-installer
[home-manager]: https://github.com/nix-community/home-manager
[nix-darwin]: https://github.com/LnL7/nix-darwin
[rootless-nix]: https://github.com/NixOS/nix/issues/1971#issue-304578884
[keyd]: https://github.com/rvaiya/keyd
[releases]: https://github.com/bigolu/system-configurations/releases/latest
