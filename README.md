# System Configurations

This repository holds the [Home Manager][home-manager] and
[nix-darwin][nix-darwin] configurations for my machines. I don't expect anyone
else to use this, but I figured I'd leave the repo public as a resource for
people who want to manage their systems similarly.

## Table of Contents

<!--
  DO NOT EDIT THE TABLE OF CONTENTS MANUALLY.
  It gets generated by doctoc:
  https://github.com/thlorenz/doctoc
  To regenerate, run `just check generate`. Though the pre-push hook will
  automatically run this for you.
-->
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [Applying a Configuration](#applying-a-configuration)
  - [Linux](#linux)
  - [macOS](#macos)
- [Running the Home Configuration](#running-the-home-configuration)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Applying a Configuration

1. Install Nix using the [Determinate Systems Nix
   Installer][determinate-systems-installer].

2. Set the binary caches by running:

   <!-- SYNC: SYS_CONF_PUBLIC_KEYS SYS_CONF_SUBS -->

   ```bash
   echo '
     extra-trusted-public-keys = bigolu.cachix.org-1:AJELdgYsv4CX7rJkuGu5HuVaOHcqlOgR07ZJfihVTIw= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
     extra-substituters = https://bigolu.cachix.org https://nix-community.cachix.org
   ' | sudo tee -a /etc/nix/nix.conf

   # Reload the daemon so it picks up the configuration changes.
   if uname | grep -q Linux; then
     systemctl restart nix-daemon.service
   else
     sudo launchctl kickstart -k system/org.nixos.nix-daemon
   fi
   ```

3. Start a Nix shell with the other required programs and clone the repository
   by running:

   ```bash
   nix shell --impure nixpkgs#fish nixpkgs#direnv nixpkgs#git \
     --command fish --init-command '
       direnv hook fish | source
       and git clone https://github.com/bigolu/system-configurations.git ~/code/system-configurations
       and cd ~/code/system-configurations
       and direnv allow
       and direnv exec "$PWD" nix-direnv-reload
     '
   ```

The next steps depend on the operating system you're using:

### Linux

1. Apply the Home Manager configuration by running
   `just init-home-manager <host_name>` where `<host_name>` is one of the hosts
   defined in the
   [Home Manager flake module](flake-modules/home-manager/default.nix).

2. Install and start [`keyd`][keyd]

3. Apply the Firefox `about:config` changes in
   `dotfiles/firefox-developer-edition/about-config-changes.txt`

### macOS

1. Apply the nix-darwin configuration by running
   `just init-nix-darwin <host_name>` where `<host_name>` is one of the hosts
   defined in the
   [nix-darwin flake module](flake-modules/nix-darwin/default.nix).

2. Keyboard:

   - Set the keyboard input source to 'Others → (No Accent Keys)'.

   <!--
     I can automate shortcuts when this issue gets resolved:
     https://github.com/LnL7/nix-darwin/issues/185
   -->

   - Shortcuts:

     - Disable: "Select the previous input source" `ctrl+space`, "Application
       windows" `ctrl+↓`

     - Change: "Mission Control → Move left/right a space" to `cmd+[` and
       `cmd+]` respectively, "Mission Control" to `cmd+d`, "Mission Control →
       Switch to Desktop 1-9" `cmd+[1-9]`

3. Open Hammerspoon, Finicky, MonitorControl, UnnaturalScrollWheels, Nightfall,
   and "Mac Mouse Fix" to configure them.

## Running the Home Configuration

You can also run a shell with the home configuration already loaded in it. This
is helpful when you only need to use the configuration temporarily and not apply
it, like when you're in a remote host or container. The executable is a
self-extracting archive (SEA) that contains all the command-line programs I use,
as well as my config files for them. You can download it from the [releases
page][releases].

> NOTE: While the SEA doesn't depend on any programs on your computer, it does
> require that you have a `/tmp` directory. You can read this [GitHub issue
> comment regarding a "rootless Nix"][rootless-nix] to see why this is needed,
> as well as learn more about how this works.

[determinate-systems-installer]:
  https://github.com/DeterminateSystems/nix-installer
[home-manager]: https://github.com/nix-community/home-manager
[nix-darwin]: https://github.com/LnL7/nix-darwin
[rootless-nix]: https://github.com/NixOS/nix/issues/1971#issue-304578884
[keyd]: https://github.com/rvaiya/keyd
[releases]: https://github.com/bigolu/system-configurations/releases/latest
