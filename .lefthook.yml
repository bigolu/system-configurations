# yaml-language-server: $schema=https://json.schemastore.org/lefthook.json

# By default lefthook uses true colors (e.g. #FFFFFF), but they may not be
# readable depending on the terminal background color. Instead I'm using ANSI
# colors since they come from the terminal's color palette.
# TODO: They should change this.
colors:
  cyan: 6
  gray: 8
  green: 2
  red: 1
  yellow: 3

source_dir: scripts/lefthook/

output:
  - failure
  - execution
  - execution_out
  - execution_info

pre-push:
  commands:
    check:
      interactive: true
      run: PRE_PUSH_HOOK=1 DIRENV_LOG_FORMAT='' direnv exec "$PWD" bash scripts/check.bash

post-merge:
  commands:
    on-change:
      run: DIRENV_LOG_FORMAT='' direnv exec "$PWD" lefthook run on-change
    home-manager-on-change:
      interactive: true
      run: DIRENV_LOG_FORMAT='' direnv exec "$PWD" bash ./.git-hook-assets/on-change.bash

post-rewrite:
  commands:
    on-change:
      only: rebase
      run: DIRENV_LOG_FORMAT='' direnv exec "$PWD" lefthook run on-change
    home-manager-on-change:
      only: rebase
      interactive: true
      run: DIRENV_LOG_FORMAT='' direnv exec "$PWD" bash ./.git-hook-assets/on-change.bash

post-checkout:
  commands:
    on-change:
      run: DIRENV_LOG_FORMAT='' direnv exec "$PWD" lefthook run on-change
  # TODO: Open an issue for passing the git hook arguments to the only/skip
  # commands. Then I could remove this script.
  scripts:
    "post-checkout.bash":
      interactive: true
      runner: DIRENV_LOG_FORMAT='' direnv exec "$PWD" bash

# NOTE: Everything here will be run in parallel:
# https://github.com/evilmartians/lefthook/issues/132#issuecomment-1833411442
on-change:
  files: git diff --name-only ORIG_HEAD HEAD
  commands:
    envrc-secrets:
      glob: "envrc-secrets-example.bash"
      run: >
        DIFF=1 DIRENV_LOG_FORMAT='' direnv exec "$PWD"
        bash scripts/print-hint.bash
        'envrc-secrets-example.bash has changed, consider updating your envrc-secrets.bash'
        {files}
    dev-shell:
      glob: "flake{.nix,.lock,-modules/**/*.nix}"
      run: >
        DIRENV_LOG_FORMAT='' direnv exec "$PWD"
        bash scripts/print-hint.bash
        'The following files have changed and may affect your devShell, consider running `just sync-nix-direnv`: '
        {files}
    # TODO: lefthook syncs hooks automatically, though I'd prefer if I had
    # control over that.
    # lefthook:
    #   glob: ".lefthook.yml"
    #   run: >
    #     DIRENV_LOG_FORMAT='' direnv exec "$PWD"
    #     bash scripts/print-hint.bash
    #     '.lefthook.yml has changed, consider running `just sync-git-hooks`'
