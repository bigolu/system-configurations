# yaml-language-server: $schema=https://json.schemastore.org/lefthook.json

# By default lefthook uses true colors (e.g. #FFFFFF), but they may not be
# readable depending on the terminal background color. Instead I'm using ANSI
# colors since they come from the terminal's color palette.
# TODO: They should change this.
colors:
  cyan: 6
  gray: 8
  green: 2
  red: 1
  yellow: 3

output:
  - failure
  - execution
  - execution_out
  - execution_info

pre-push:
  commands:
    check:
      interactive: true
      run: PRE_PUSH_HOOK=1 DIRENV_LOG_FORMAT='' direnv exec "$PWD" bash scripts/check.bash

post-merge:
  commands:
    change-notifications:
      interactive: true
      run: DIRENV_LOG_FORMAT='' direnv exec "$PWD" lefthook run change-notifications

post-rewrite:
  commands:
    change-notifications:
      only: rebase
      interactive: true
      run: DIRENV_LOG_FORMAT='' direnv exec "$PWD" lefthook run change-notifications

post-checkout:
  commands:
    change-notifications:
      interactive: true
      # TODO: Open an issue for passing the git hook arguments to the only/skip
      # commands. Then I could remove this script.
      run: DIRENV_LOG_FORMAT='' direnv exec "$PWD" bash scripts/git-hooks/run-if-not-file-checkout.bash lefthook run change-notifications

# NOTE: Everything here will be run in parallel:
# https://github.com/evilmartians/lefthook/issues/132#issuecomment-1833411442
change-notifications:
  files: git diff --name-only ORIG_HEAD HEAD
  commands:
    envrc-secrets:
      glob: "envrc-secrets-example.bash"
      run: >
        DIFF=1 DIRENV_LOG_FORMAT='' direnv exec "$PWD"
        bash scripts/git-hooks/change-notifications/notify.bash
        'envrc-secrets-example.bash has changed, consider updating your envrc-secrets.bash'
        {files}
    dev-shell:
      glob: "flake{.nix,.lock,-modules/**/*.nix}"
      run: >
        DIRENV_LOG_FORMAT='' direnv exec "$PWD"
        bash scripts/git-hooks/change-notifications/notify.bash
        'The following files have changed and may affect your devShell, consider running `just sync-nix-direnv`: '
        {files}
    home-manager:
      run: >
        DIRENV_LOG_FORMAT='' direnv exec "$PWD"
        bash scripts/git-hooks/change-notifications/home-manager/check-for-changes.bash
    # TODO: lefthook syncs hooks automatically, though I'd prefer if I had
    # control over that.
    # lefthook:
    #   glob: ".lefthook.yml"
    #   run: >
    #     DIRENV_LOG_FORMAT='' direnv exec "$PWD"
    #     bash scripts/git-hooks/change-notifications/notify.bash
    #     '.lefthook.yml has changed, consider running `just sync-git-hooks`'
