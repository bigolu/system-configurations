# yaml-language-server: $schema=https://raw.githubusercontent.com/mattn/efm-langserver/master/schema.json

version: 2

lint-debounce: 200ms

tools:
  taplo: &taplo
    format-stdin: true
    format-command: taplo format --stdin-filepath ${INPUT} -
  prettier: &prettier
    format-stdin: true
    format-command: |
      # The outer and inner case statements represent include and exclude globs
      # respectively.
      case ${INPUT} in
        *)
          case ${INPUT} in
            */npins/* | */.vscode/*.json)
              cat
              ;;
            *)
              prettier --stdin-filepath ${INPUT}
              ;;
          esac
          ;;
      esac
  shfmt: &shfmt
    format-stdin: true
    format-command: shfmt --filename ${INPUT} -
  fish_indent: &fish_indent
    format-stdin: true
    format-command: fish_indent
  nixfmt: &nixfmt
    format-stdin: true
    format-command: |
      # The outer and inner case statements represent include and exclude globs
      # respectively.
      case ${INPUT} in
        *)
          case ${INPUT} in
            */npins/*)
              cat
              ;;
            *)
              nixfmt --verify --filename ${INPUT}
              ;;
          esac
          ;;
      esac
  stylua: &stylua
    format-stdin: true
    format-command: stylua --verify --stdin-filepath ${INPUT} -
  gofmt: &gofmt
    format-stdin: true
    format-command: gofmt
  ruff: &ruff
    format-stdin: true
    format-command: ruff format --stdin-filename ${INPUT}
  actionlint: &actionlint
    lint-source: actionlint
    lint-after-open: true
    lint-stdin: true
    lint-command: |
      # The outer and inner case statements represent include and exclude globs
      # respectively.
      case ${INPUT} in
        */.github/workflows/*)
          case ${INPUT} in
            *)
              actionlint -no-color -
              ;;
          esac
          ;;
      esac
    lint-formats:
      - "%f:%l:%c: %m"
  markdownlint-cli2: &markdownlint-cli2
    lint-source: markdownlint-cli2
    lint-after-open: true
    lint-stdin: true
    lint-command: markdownlint-cli2 -
    lint-formats:
      - "%f:%l:%c %m"
      - "%f:%l %m"
  config-file-validator: &config-file-validator
    lint-source: config-file-validator
    lint-after-open: true
    lint-stdin: true
    lint-ignore-exit-code: true
    # dependencies: cat, mktemp, jq
    lint-command: |
      # The outer and inner case statements represent include and exclude globs
      # respectively.
      case ${INPUT} in
        *)
          case ${INPUT} in
            */npins/* | */.vscode/*.json)
              :
              ;;
            *)
              input=${INPUT}
              basename="${input##*/}"
              extension=".${basename##*.}"
              temp="$(mktemp --suffix "$extension")"
              cat >"$temp"
              validator -groupby pass-fail -reporter json -- "$temp" |
                jq --raw-output --arg input "$input" '.files.Failed.[]? | "\($input): \(.error)"'
              ;;
          esac
          ;;
      esac
    lint-formats:
      - "%f: %m"
  typos: &typos
    lint-source: typos
    lint-after-open: true
    lint-stdin: true
    lint-command: typos --color never --format brief -
    lint-formats:
      - "%f:%l:%c: %m"
  statix: &statix
    lint-source: statix
    lint-after-open: true
    lint-stdin: true
    lint-command: |
      # The outer and inner case statements represent include and exclude globs
      # respectively.
      case ${INPUT} in
        *)
          case ${INPUT} in
            */npins/*)
              :
              ;;
            *)
              statix check --stdin --format errfmt
              ;;
          esac
          ;;
      esac
    lint-formats:
      - "%f>%l:%c:%t:%n:%m"
  nixpkgs-lint: &nixpkgs-lint
    lint-source: nixpkgs-lint
    lint-after-open: true
    lint-stdin: true
    lint-ignore-exit-code: true
    # dependencies: cat, mktemp, jq
    lint-command: |
      # The outer and inner case statements represent include and exclude globs
      # respectively.
      case ${INPUT} in
        *)
          case ${INPUT} in
            */npins/*)
              :
              ;;
            *)
              input=${INPUT}
              basename="${input##*/}"
              extension=".${basename##*.}"
              temp="$(mktemp --suffix "$extension")"
              cat >"$temp"
              nixpkgs-lint --include-unfinished-lints --format json -- "$temp" |
                jq \
                  --raw-output \
                  --arg input "$input" \
                  '.[] | "\($input):\(.line):\(.column): \(.message)"'
              ;;
          esac
          ;;
      esac
    lint-formats:
      - "%f:%l:%c: %m"
  staticcheck: &staticcheck
    lint-source: staticcheck
    lint-after-open: true
    lint-stdin: false
    lint-on-save: true
    lint-ignore-exit-code: true
    # dependencies: jq
    lint-command: |
      cd gozip
      staticcheck -f json ${INPUT} |
        jq \
          --raw-output \
          '"\(.location.file):\(.location.line):\(.location.column): \(.message)"'
    lint-formats:
      - "%f:%l:%c: %m"

languages:
  toml:
    - <<: *taplo
    - <<: *config-file-validator
  markdown:
    - <<: *prettier
    - <<: *markdownlint-cli2
  json:
    - <<: *prettier
    - <<: *config-file-validator
  jsonc:
    - <<: *prettier
  json5:
    - <<: *prettier
  yaml:
    - <<: *prettier
    - <<: *actionlint
    - <<: *config-file-validator
  shellscript:
    - <<: *shfmt
  fish:
    - <<: *fish_indent
  nix:
    - <<: *nixfmt
    - <<: *statix
    - <<: *nixpkgs-lint
  lua:
    - <<: *stylua
  go:
    - <<: *gofmt
    - <<: *staticcheck
  python:
    - <<: *ruff
  editorconfig:
    - <<: *config-file-validator
  ini:
    - <<: *config-file-validator
  =:
    - <<: *typos
