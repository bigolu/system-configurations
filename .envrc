# shellcheck shell=bash

# Dependencies
source_url 'https://raw.githubusercontent.com/nix-community/nix-direnv/3.0.5/direnvrc' 'sha256-RuwIS+QKFj/T9M2TFXScjBsLR6V3A17YVoEW/Q6AZ1w='

add_lines_to_nix_config() {
  for line in "$@"; do
    NIX_CONFIG="${NIX_CONFIG:-}"$'\n'"$line"
  done
  export NIX_CONFIG
}

# nix
nix_wrapper_path="$(dirname "$(which nix)")"
nix_direnv_manual_reload
use flake
shopt -s globstar # so the following glob works
watch_file flake-modules/**/*.nix
# I want to use my nix wrapper so I need to prepend it to the PATH after the
# flake bin is added. I first try to remove it from the PATH so there are not
# duplicates.
PATH_rm "$nix_wrapper_path"
PATH_add "$nix_wrapper_path"
add_lines_to_nix_config \
  'extra-substituters = https://bigolu.cachix.org' \
  'extra-trusted-public-keys = bigolu.cachix.org-1:AJELdgYsv4CX7rJkuGu5HuVaOHcqlOgR07ZJfihVTIw='
if [ -n "${TREESITTER_PARSERS:-}" ]; then
  dest='.ast-grep/parsers'
  rm "$dest"
  ln --symbolic "$TREESITTER_PARSERS" "$dest"
fi

layout go

# secrets
function get_secret {
  path="./secrets/$1"

  if [ -f "$path" ]; then
    cat "$path"
  else
    yellow='\e[33m'
    reset='\e[m'
    echo -e "[${yellow}warning${reset}] secret '$path' was not found" 1>&2
    return 1
  fi
}
if github="$(get_secret 'github.txt')"; then
  add_lines_to_nix_config "extra-access-tokens = github.com=$github"
  # For lychee
  export GITHUB_TOKEN="$github"
fi
if bws="$(get_secret 'bws.txt')"; then
  export BWS_ACCESS_TOKEN="$bws"
fi
IFS= readarray -d '' secret_files < <(find "$PWD/secrets" -type f \! -name .DS_Store -print0)
for secret_file in "${secret_files[@]}"; do
  watch_file "$secret_file"
done
