# shellcheck shell=bash

# Dependencies
#
# WARNING: Renovate uses a regular expression to find these dependencies
# and update them. To ensure the regular expression find a match, the lines
# declaring the dependencies should not be changed in any way. For example,
# splitting the command to multiple lines using '\'.
source_url 'https://raw.githubusercontent.com/nix-community/nix-direnv/3.0.5/direnvrc' 'sha256-RuwIS+QKFj/T9M2TFXScjBsLR6V3A17YVoEW/Q6AZ1w='

function set_up_environment {
  layout go
  set_up_nix
  set_up_secrets
}

function set_up_nix {
  nix_wrapper_path="$(dirname "$(which nix)")"

  nix_direnv_manual_reload
  use flake
  shopt -s globstar # so the following glob works
  watch_file flake-modules/**/*.nix

  # I want to use my nix wrapper so I need to prepend it to the PATH after the
  # flake bin is added. I first try to remove it from the PATH so there are not
  # duplicates.
  PATH_rm "$nix_wrapper_path"
  PATH_add "$nix_wrapper_path"

  add_lines_to_nix_config \
    'extra-substituters = https://bigolu.cachix.org' \
    'extra-trusted-public-keys = bigolu.cachix.org-1:AJELdgYsv4CX7rJkuGu5HuVaOHcqlOgR07ZJfihVTIw='
  create_symlink_to_path_in_environment_variable TREESITTER_PARSERS '.ast-grep/parsers'
  create_symlink_to_path_in_environment_variable LUA_LS_LIBRARIES '.lua-ls-libraries'
}

function set_up_secrets {
  if github="$(get_secret 'github.txt')"; then
    # To avoid being rate-limited by GitHub during `nix flake update`
    add_lines_to_nix_config "extra-access-tokens = github.com=$github"

    # For lychee
    export GITHUB_TOKEN="$github"
  fi

  if bws="$(get_secret 'bws.txt')"; then
    export BWS_ACCESS_TOKEN="$bws"
  fi

  readarray -d '' secret_files < <(find "$PWD/secrets" -type f \! -name .DS_Store -print0)
  watch_file "${secret_files[@]}"
}

function add_lines_to_nix_config {
  for line in "$@"; do
    NIX_CONFIG="${NIX_CONFIG:-}"$'\n'"$line"
  done
  export NIX_CONFIG
}

function create_symlink_to_path_in_environment_variable {
  # The empty check is necessary because:
  # - If you add an env variable to be linked and haven't run `just
  # sync-nix-direnv`, direnv will fail.
  # - If you pull and a new variable is added it won't be there till you sync.
  # - If you just cloned repo it won't be there till you sync.
  # - If you checkout a commit and you don't have env var it fails.
  if [ -n "${!1:-}" ]; then
    if [ -L "$2" ]; then
      rm "$2"
    fi
    ln --symbolic "${!1}" "$2"
  fi
}

function get_secret {
  path="./secrets/$1"
  if [ -f "$path" ]; then
    cat "$path"
  else
    if [ -t 2 ]; then
      yellow='\e[33m'
      reset='\e[m'
      echo -e "[${yellow}warning${reset}] secret '$path' was not found, run 'just get-secrets' to get all of the secrets." 1>&2
    fi
    return 1
  fi
}

set_up_environment
