# shellcheck shell=bash

function main {
  # They get pretty noisy
  hide_logs
  set_up_nix
  layout go
  dotenv_if_exists secrets.env
  print_reminder_to_reload_direnv_in_editor
}

function hide_logs {
  if [[ -t 1 ]]; then
    export DIRENV_LOG_FORMAT=''
  fi
}

function set_up_nix {
  # SYNC: SYS_CONF_SUBS
  export NIX_CONFIG+=$'\nextra-substituters = https://bigolu.cachix.org https://nix-community.cachix.org'

  source_url \
    'https://raw.githubusercontent.com/nix-community/nix-direnv/3.0.6/direnvrc' \
    'sha256-RYcUJaRMf8oF5LznDrlCXbkOQrywm0HDv1VjYGaJGdM='
  # The flake evaluation cache for a devShell seems to be invalidated by any change
  # to the repo. Since evaluation is pretty slow, I'll manually reload the devShell.
  nix_direnv_manual_reload
  use flake .#
}

function print_reminder_to_reload_direnv_in_editor {
  # I only want to print the reminder if direnv is being reloaded, not on the first
  # load. The DIRENV_DIFF variable won't be set on the first load so if it's set,
  # direnv must be reloading.
  if [[ -n ${DIRENV_DIFF+set} && -t 1 ]]; then
    printf '\n\e[34mâ”ƒ tip: Remember to reload direnv inside your editor as well.\e(B\e[m\n'
  fi
}

main
