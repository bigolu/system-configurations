# shellcheck shell=bash

# Don't show any logs, it gets pretty noisy.
if [[ -t 1 ]]; then
  export DIRENV_LOG_FORMAT=''
fi

# Dependencies
#
# WARNING: Renovate uses a regular expression to find these dependencies
# and update them. To ensure the regular expression finds a match, the lines
# declaring the dependencies should not be changed in any way. For example,
# splitting the command to multiple lines using '\'.
source_url 'https://raw.githubusercontent.com/nix-community/nix-direnv/3.0.6/direnvrc' 'sha256-RYcUJaRMf8oF5LznDrlCXbkOQrywm0HDv1VjYGaJGdM='

function load_environment {
  load_nix
  layout go
  load_secrets

  # Add this last so the programs here get priority, since they're wrappers.
  load_wrappers
}

function load_nix {
  nix_direnv_manual_reload
  use flake .#

  # I want to use my nix wrapper so I need to prepend it to the PATH after the
  # flake bin is added. I first try to remove it from the PATH so there are no
  # duplicates.
  local nix_wrapper_path="$HOME/.local/bin"
  PATH_rm "$nix_wrapper_path"
  PATH_add "$nix_wrapper_path"
}

function load_secrets {
  local -r path='envrc-secrets.bash'
  if [[ -e "$path" ]]; then
    # shellcheck disable=1090
    source "$path"
  fi
}

function load_wrappers {
  dir="$(direnv_layout_dir)/wrappers"
  mkdir -p "$dir"
  symlink "$PWD/scripts/gh.bash" "$dir/gh"
  PATH_add "$dir"
}

function symlink {
  source="$1"
  destination="$2"

  if [ -L "$destination" ]; then
    rm "$destination"
  fi
  ln -s "$source" "$destination"
}

load_environment
