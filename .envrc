# shellcheck shell=bash

# Don't show any logs, it gets pretty noisy.
if [[ -t 1 ]]; then
  export DIRENV_LOG_FORMAT=''
fi

# Dependencies
#
# WARNING: Renovate uses a regular expression to find these dependencies
# and update them. To ensure the regular expression finds a match, the lines
# declaring the dependencies should not be changed in any way. For example,
# splitting the command to multiple lines using '\'.
source_url 'https://raw.githubusercontent.com/nix-community/nix-direnv/3.0.6/direnvrc' 'sha256-RYcUJaRMf8oF5LznDrlCXbkOQrywm0HDv1VjYGaJGdM='

function set_up_environment {
  set_up_nix
  layout go
  dotenv_if_exists secrets.env
  set_up_lua
}

function set_up_nix {
  # This can't go inside the devShell shellHook because the substituters have to be
  # set before evaluation starts.
  #
  # SYNC: SYS_CONF_SUBS
  export NIX_CONFIG="${NIX_CONFIG:-}"$'\n''extra-substituters = https://bigolu.cachix.org https://nix-community.cachix.org'

  # Reasons I don't want it to automatically reload:
  #   - It runs whenever a watched file's modification time changes, even if the
  #     contents are the same.
  #   - It runs on checkout and interactive rebase
  nix_direnv_manual_reload
  use flake .#
}

function set_up_lua {
  hammerspoon_annotations="$HOME/.hammerspoon/Spoons/EmmyLua.spoon/annotations"
  if [[ -e "$hammerspoon_annotations" ]]; then
    # SYNC: LUA_LIBRARY_PREFIX
    symlink "$hammerspoon_annotations" .lua-libraries/hammerspoon-annotations
  fi
}

function symlink {
  mkdir --parents "$(dirname "$2")"
  ln --symbolic --force --no-dereference "$1" "$2"
}

set_up_environment
