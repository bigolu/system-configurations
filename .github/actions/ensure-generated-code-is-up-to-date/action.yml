name: Ensure generated code is up to date
description: Ensure generated code is up to date
inputs:
  cachix-auth-token:
    description: Cachix auth token
    required: true
runs:
  using: "composite"
  steps:
    - uses: ./.github/actions/setup
      with:
        dev-shell: ciCodegen
        cachix-auth-token: "${{ inputs.cachix-auth-token }}"
    - shell: ci-bash {0}
      run: lefthook run generate --all-files
    # The command run in the previous step fails if it updates any generated code.
    # This causes the step that it's run in to fail as well. If that happens, then by
    # default this step, and all steps after it, wouldn't get run. That means this
    # step wouldn't be able to report the generated code that got updated.
    #
    # We could've used something like `<command> || true` to suppress the error, but
    # if the command failed for a reason besides having updated the generated code,
    # we would suppress that error too.
    #
    # We could have used `always()` to ensure this step runs, but that would mean
    # even if the workflow was cancelled by a user, this step would still run.
    #
    # Instead, we say only run if the workflow wasn't cancelled. This way, we still
    # have the ability to cancel all the steps in the workflow while also allowing
    # this step to run even if previous ones fail.
    - if: "!cancelled()"
      shell: ci-bash {0}
      run: |
        git diff |
        ./scripts/reviewdog.bash \
          -name=code-generation \
          -f=diff \
          -f.diff.strip=1
